import tkinter as tk
from tkinter import simpledialog, messagebox
from Npp import *

handled_lines = {}

status_options = ['Active', 'Inactive']
lob_options = [
    'Artisan Contractor', 'Auto Service & Repair', 'Commercial Auto',
    'Habitational', 'Manufacturing', 'Real Estate', 'Restaurant',
    'Retail', 'Umbrella', 'Wholesale'
]

def ask_choice(title, message, choices):
    root = tk.Tk()
    root.withdraw()
    while True:
        response = simpledialog.askstring(title, message + "\nOptions:\n" + '\n'.join(choices))
        if response is None:
            return None
        response = response.strip()
        if response in choices:
            return response
        messagebox.showerror("Invalid Input", "Please choose one of:\n" + '\n'.join(choices))

def insert_form():
    form = (
        "SR# \n\n"
        "Policy:\n"
        "Policy Status:\n"
        "Line of Business:\n"
        "Session:\n"
    )
    editor.insertText(0, form)

def on_update(args):
    caret_line = editor.lineFromPosition(editor.getCurrentPos())
    line_text = editor.getLine(caret_line).strip()

    if line_text.lower().startswith("policy status:"):
        suffix = line_text[14:].strip()
        if not suffix and not handled_lines.get(('status', caret_line), False):
            selected = ask_choice("Policy Status", "Select Policy Status:", status_options)
            if selected:
                editor.replaceWholeLine(caret_line, "Policy Status: " + selected + "\n")
                handled_lines[('status', caret_line)] = True

    elif line_text.lower().startswith("line of business:"):
        suffix = line_text[17:].strip()
        if not suffix and not handled_lines.get(('lob', caret_line), False):
            selected = ask_choice("Line of Business", "Select Line of Business:", lob_options)
            if selected:
                editor.replaceWholeLine(caret_line, "Line of Business: " + selected + "\n")
                handled_lines[('lob', caret_line)] = True

# Clear any old triggers and start clean
notepad.clearCallbacks([NOTIFICATION.UPDATEUI])
insert_form()
notepad.callback(on_update, [NOTIFICATION.UPDATEUI])
