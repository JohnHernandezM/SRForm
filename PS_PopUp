import Tkinter
import tkSimpleDialog
import tkMessageBox
from Npp import *

# Keep track of handled lines by (type, line number)
handled_lines = {}

# Dropdown options
status_options = ['Active', 'Inactive']
lob_options = [
    'Artisan Contractor', 'Auto Service & Repair', 'Commercial Auto',
    'Habitational', 'Manufacturing', 'Real Estate', 'Restaurant',
    'Retail', 'Umbrella', 'Wholesale'
]

def ask_choice(title, message, choices):
    root = Tkinter.Tk()
    root.withdraw()
    while True:
        response = tkSimpleDialog.askstring(title, message + "\nOptions:\n" + '\n'.join(choices))
        if response is None:
            return None
        response = response.strip()
        if response in choices:
            return response
        tkMessageBox.showerror("Invalid Input", "Please choose one of:\n" + '\n'.join(choices))

def insert_form():
    form = (
        "SR# \n\n"
        "Policy:\n"
        "Policy Status:\n"
        "Line of Business:\n"
        "Session:\n"
    )
    # Insert at the very beginning of the file
    editor.setText(form + editor.getText())

def on_update(args):
    caret_line = editor.lineFromPosition(editor.getCurrentPos())
    line_text = editor.getLine(caret_line).strip()

    # POLICY STATUS
    if line_text.lower().startswith("policy status:"):
        suffix = line_text[14:].strip()
        if not suffix and not handled_lines.get(('status', caret_line), False):
            selected = ask_choice("Policy Status", "Select Policy Status:", status_options)
            if selected:
                editor.replaceWholeLine(caret_line, "Policy Status: " + selected + "\n")
                handled_lines[('status', caret_line)] = True

    # LINE OF BUSINESS
    elif line_text.lower().startswith("line of business:"):
        suffix = line_text[17:].strip()
        if not suffix and not handled_lines.get(('lob', caret_line), False):
            selected = ask_choice("Line of Business", "Select Line of Business:", lob_options)
            if selected:
                editor.replaceWholeLine(caret_line, "Line of Business: " + selected + "\n")
                handled_lines[('lob', caret_line)] = True

# --- MAIN ENTRY POINT ---

# Clear existing update triggers
notepad.clearCallbacks([NOTIFICATION.UPDATEUI])

# Insert the SR form
insert_form()

# Attach the update listener (real-time caret/typing)
notepad.callback(on_update, [NOTIFICATION.UPDATEUI])
